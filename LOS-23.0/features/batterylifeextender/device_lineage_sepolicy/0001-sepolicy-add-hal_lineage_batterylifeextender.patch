From 8465496925135c9eb605955f65d75c2a6770bd0f Mon Sep 17 00:00:00 2001
From: Francescodario Cuzzocrea <bosconovic@gmail.com>
Date: Sat, 31 Jul 2021 10:14:27 +0200
Subject: [PATCH 1/1] sepolicy: add hal_lineage_batterylifeextender

Change-Id: Ib5f8c3d1b0af4197277d814e4c06b5362ed2cac2
---
 common/dynamic/hal_lineage_batterylifeextender.te        | 8 ++++++++
 common/dynamic/hwservice.te                              | 1 +
 common/dynamic/hwservice_contexts                        | 1 +
 common/private/platform_app.te                           | 3 +++
 common/private/system_app.te                             | 1 +
 common/private/system_server.te                          | 1 +
 common/public/attributes                                 | 1 +
 common/vendor/hal_lineage_batterylifeextender_default.te | 5 +++++
 8 files changed, 21 insertions(+)
 create mode 100644 common/dynamic/hal_lineage_batterylifeextender.te
 create mode 100644 common/dynamic/hwservice.te
 create mode 100644 common/vendor/hal_lineage_batterylifeextender_default.te

diff --git a/common/dynamic/hal_lineage_batterylifeextender.te b/common/dynamic/hal_lineage_batterylifeextender.te
new file mode 100644
index 0000000..a52bca4
--- /dev/null
+++ b/common/dynamic/hal_lineage_batterylifeextender.te
@@ -0,0 +1,8 @@
+# HWBinder IPC from client to server
+binder_call(hal_lineage_batterylifeextender_client, hal_lineage_batterylifeextender_server)
+
+add_hwservice(hal_lineage_batterylifeextender_server, hal_lineage_batterylifeextender_hwservice)
+allow hal_lineage_batterylifeextender_client hal_lineage_batterylifeextender_hwservice:hwservice_manager find;
+
+# Allow binder communication with platform_app
+binder_call(hal_lineage_batterylifeextender, platform_app)
diff --git a/common/dynamic/hwservice.te b/common/dynamic/hwservice.te
new file mode 100644
index 0000000..58f8abf
--- /dev/null
+++ b/common/dynamic/hwservice.te
@@ -0,0 +1 @@
+type hal_lineage_batterylifeextender_hwservice, hwservice_manager_type;
\ No newline at end of file
diff --git a/common/dynamic/hwservice_contexts b/common/dynamic/hwservice_contexts
index 9366d42..e144078 100644
--- a/common/dynamic/hwservice_contexts
+++ b/common/dynamic/hwservice_contexts
@@ -1 +1,2 @@
 motorola.hardware.health::IMotHealth    u:object_r:hal_health_hwservice:s0
+vendor.lineage.batterylifeextender::IBatteryLifeExtender                u:object_r:hal_lineage_batterylifeextender_hwservice:s0
diff --git a/common/private/platform_app.te b/common/private/platform_app.te
index 86e4708..6b61380 100644
--- a/common/private/platform_app.te
+++ b/common/private/platform_app.te
@@ -1,6 +1,9 @@
 # Allow NFC service to be found
 allow platform_app nfc_service:service_manager find;
 
+# Allow BatteryLifeExtender HAL service to be found
+hal_client_domain(platform_app, hal_lineage_batterylifeextender)
+
 # Allow LiveDisplay HAL service to be found
 hal_client_domain(platform_app, hal_lineage_livedisplay)
 
diff --git a/common/private/system_app.te b/common/private/system_app.te
index f62d6f3..0ab55b7 100644
--- a/common/private/system_app.te
+++ b/common/private/system_app.te
@@ -8,6 +8,7 @@ get_prop(system_app, custom_version_prop)
 get_prop(system_app, vendor_security_patch_level_prop)
 
 # Allow access to the HALs
+hal_client_domain(system_app, hal_lineage_batterylifeextender)
 hal_client_domain(system_app, hal_lineage_livedisplay)
 hal_client_domain(system_app, hal_lineage_touch)
 
diff --git a/common/private/system_server.te b/common/private/system_server.te
index fdac25c..a87b442 100644
--- a/common/private/system_server.te
+++ b/common/private/system_server.te
@@ -3,6 +3,7 @@ allow system_server storage_stub_file:dir getattr;
 allow system_server adbroot_service:service_manager find;
 
 # Use HALs
+hal_client_domain(system_server, hal_lineage_batterylifeextender)
 hal_client_domain(system_server, hal_lineage_health)
 hal_client_domain(system_server, hal_lineage_livedisplay)
 hal_client_domain(system_server, hal_lineage_touch)
diff --git a/common/public/attributes b/common/public/attributes
index bff79d0..5b86797 100644
--- a/common/public/attributes
+++ b/common/public/attributes
@@ -1,4 +1,5 @@
 # HALs
+hal_attribute_lineage(lineage_batterylifeextender)
 hal_attribute_lineage(lineage_health)
 hal_attribute_lineage(lineage_livedisplay)
 hal_attribute_lineage(lineage_touch)
diff --git a/common/vendor/hal_lineage_batterylifeextender_default.te b/common/vendor/hal_lineage_batterylifeextender_default.te
new file mode 100644
index 0000000..6d97078
--- /dev/null
+++ b/common/vendor/hal_lineage_batterylifeextender_default.te
@@ -0,0 +1,5 @@
+type hal_lineage_batterylifeextender_default, domain;
+hal_server_domain(hal_lineage_batterylifeextender_default, hal_lineage_batterylifeextender)
+
+type hal_lineage_batterylifeextender_default_exec, exec_type, vendor_file_type, file_type;
+init_daemon_domain(hal_lineage_batterylifeextender_default)
-- 
2.51.0

