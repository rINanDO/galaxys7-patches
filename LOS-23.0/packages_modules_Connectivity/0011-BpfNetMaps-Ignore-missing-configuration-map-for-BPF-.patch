From 09a5fc60070662fc96663f7b5705adbf2746fb69 Mon Sep 17 00:00:00 2001
From: Dominggoes Isakh <drjisakh@gmail.com>
Date: Sun, 9 Feb 2025 12:02:46 -0500
Subject: [PATCH 11/14] BpfNetMaps: Ignore missing configuration map for
 BPF-less devices

Change-Id: Ia1919b99e233d93113ff7ccecb884942f75d6abe
---
 service/src/com/android/server/BpfNetMaps.java | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/service/src/com/android/server/BpfNetMaps.java b/service/src/com/android/server/BpfNetMaps.java
index 938609c2bd..5bd5afa491 100644
--- a/service/src/com/android/server/BpfNetMaps.java
+++ b/service/src/com/android/server/BpfNetMaps.java
@@ -303,6 +303,9 @@ public class BpfNetMaps {
         if (sConfigurationMap == null) {
             sConfigurationMap = getConfigurationMap();
         }
+
+        if (sConfigurationMap == null) return;
+
         try {
             sConfigurationMap.updateEntry(UID_RULES_CONFIGURATION_KEY,
                     new U32(UID_RULES_DEFAULT_CONFIGURATION));
@@ -587,6 +590,8 @@ public class BpfNetMaps {
     @Deprecated
     @RequiresApi(Build.VERSION_CODES.TIRAMISU)
     public boolean isChainEnabled(final int childChain) {
+        if (sConfigurationMap == null) return false;
+
         return BpfNetMapsUtils.isChainEnabled(sConfigurationMap, childChain);
     }
 
@@ -1085,6 +1090,8 @@ public class BpfNetMaps {
      */
     @RequiresApi(Build.VERSION_CODES.TIRAMISU)
     public int getNetPermForUid(final int uid) {
+        if (sUidPermissionMap == null) return TRAFFIC_PERMISSION_INTERNET;
+
         final int appId = UserHandle.getAppId(uid);
         try {
             // Key of uid permission map is appId
@@ -1173,6 +1180,8 @@ public class BpfNetMaps {
      */
     @RequiresApi(Build.VERSION_CODES.TIRAMISU)
     public int getUidNetworkingBlockedReasons(final int uid) {
+        if (sConfigurationMap == null) return 0;
+
         return BpfNetMapsUtils.getUidNetworkingBlockedReasons(uid,
                 sConfigurationMap, sUidOwnerMap, sDataSaverEnabledMap);
     }
@@ -1204,6 +1213,8 @@ public class BpfNetMaps {
      */
     @RequiresApi(Build.VERSION_CODES.TIRAMISU)
     public boolean isUidNetworkingBlocked(final int uid, boolean isNetworkMetered) {
+        if (sConfigurationMap == null) return false;
+
         return BpfNetMapsUtils.isUidNetworkingBlocked(uid, isNetworkMetered,
                 sConfigurationMap, sUidOwnerMap, sDataSaverEnabledMap);
     }
-- 
2.51.0

