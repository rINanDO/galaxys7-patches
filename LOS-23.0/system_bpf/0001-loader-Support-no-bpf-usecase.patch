From 3c68a55bd6926a14f6eb869a4f7aec0c364c2ea0 Mon Sep 17 00:00:00 2001
From: Dominggoes Isakh <drjisakh@gmail.com>
Date: Tue, 21 Jan 2025 14:52:01 -0500
Subject: [PATCH] loader: Support no bpf usecase

Change-Id: I5b99fb83001debd08d910569387e08970b78e8d3
---
 loader/Loader.cpp               | 13 +++++++------
 loader/include/libbpf_android.h |  2 +-
 2 files changed, 8 insertions(+), 7 deletions(-)

diff --git a/loader/Loader.cpp b/loader/Loader.cpp
index 940ce19..6940a5f 100644
--- a/loader/Loader.cpp
+++ b/loader/Loader.cpp
@@ -977,7 +977,8 @@ void initLogging() {
 void createBpfFsSubDirectories() {
     for (const auto& location : android::bpf::locations) {
         if (android::bpf::createSysFsBpfSubDir(location.prefix)) {
-            exit(120);
+    ALOGE("BPF Ignored 120: createSysFsBpfSubDir(%s)", location.prefix);
+//          exit(120);
         }
     }
 }
@@ -990,9 +991,9 @@ void legacyBpfLoader() {
             ALOGE("If this triggers reliably, you're probably missing kernel options or patches.");
             ALOGE("If this triggers randomly, you might be hitting some memory allocation "
                   "problems or startup script race.");
-            ALOGE("--- DO NOT EXPECT SYSTEM TO BOOT SUCCESSFULLY ---");
-            sleep(20);
-            exit(121);
+            ALOGE("BPF Ignored 121: CONTINUE SYSTEM TO BOOT ---");
+//            sleep(20);
+//            exit(121);
         }
     }
 }
@@ -1000,6 +1001,6 @@ void legacyBpfLoader() {
 void execNetBpfLoadDone() {
     const char* args[] = {"/apex/com.android.tethering/bin/netbpfload", "done", NULL};
     execve(args[0], (char**)args, environ);
-    ALOGE("FATAL: execve(): %d[%s]", errno, strerror(errno));
-    exit(122);
+    ALOGE("BPF Ignored 122: execve(): %d[%s]", errno, strerror(errno));
+//     exit(122);
 }
diff --git a/loader/include/libbpf_android.h b/loader/include/libbpf_android.h
index ae4a36d..01281db 100644
--- a/loader/include/libbpf_android.h
+++ b/loader/include/libbpf_android.h
@@ -51,7 +51,7 @@ extern "C" {
 void initLogging();
 void createBpfFsSubDirectories();
 void legacyBpfLoader();
-__noreturn void execNetBpfLoadDone();
+void execNetBpfLoadDone();
 
 #ifdef __cplusplus
 }  // extern C
-- 
2.51.0

