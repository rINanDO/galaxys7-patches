From eb03028ab764b395469608fdebdbdbab2e6eb603 Mon Sep 17 00:00:00 2001
From: Pierre-Hugues Husson <phh@phh.me>
Date: Wed, 18 Oct 2023 16:53:40 -0400
Subject: [PATCH 2/3] Ignore cgroup creation errors

For old kernels who don't have those modern cgroups
---
 core/jni/com_android_internal_os_Zygote.cpp   | 25 ++++++++-------
 .../com/android/server/am/ProcessList.java    | 32 +++++++++----------
 2 files changed, 29 insertions(+), 28 deletions(-)

diff --git a/core/jni/com_android_internal_os_Zygote.cpp b/core/jni/com_android_internal_os_Zygote.cpp
index b1c1121771c5..aa631eb83e3c 100644
--- a/core/jni/com_android_internal_os_Zygote.cpp
+++ b/core/jni/com_android_internal_os_Zygote.cpp
@@ -1967,18 +1967,19 @@ static void SpecializeCommon(JNIEnv* env, uid_t uid, gid_t gid, jintArray gids,
     // If this zygote isn't root, it won't be able to create a process group,
     // since the directory is owned by root.
     if (getuid() == 0) {
-        const int rc = createProcessGroup(uid, getpid());
-        if (rc != 0) {
-            if (rc == -ESRCH) {
-                // If process is dead, treat this as a non-fatal error
-                ALOGE("createProcessGroup(%d, %d) failed: %s", uid, /* pid= */ 0, strerror(-rc));
-            } else {
-                fail_fn(rc == -EROFS ? CREATE_ERROR("createProcessGroup failed, kernel missing "
-                                                    "CONFIG_CGROUP_CPUACCT?")
-                                     : CREATE_ERROR("createProcessGroup(%d, %d) failed: %s", uid,
-                                                    /* pid= */ 0, strerror(-rc)));
-            }
-        }
+        createProcessGroup(uid, getpid());
+        // const int rc = createProcessGroup(uid, getpid());
+        // if (rc != 0) {
+        //     if (rc == -ESRCH) {
+        //         // If process is dead, treat this as a non-fatal error
+        //         ALOGE("createProcessGroup(%d, %d) failed: %s", uid, /* pid= */ 0, strerror(-rc));
+        //     } else {
+        //         fail_fn(rc == -EROFS ? CREATE_ERROR("createProcessGroup failed, kernel missing "
+        //                                             "CONFIG_CGROUP_CPUACCT?")
+        //                              : CREATE_ERROR("createProcessGroup(%d, %d) failed: %s", uid,
+        //                                             /* pid= */ 0, strerror(-rc)));
+        //     }
+        // }
 
         if (is_system_server && UsePerAppMemcg()) {
             // Assign system_server to the correct memory cgroup.
diff --git a/services/core/java/com/android/server/am/ProcessList.java b/services/core/java/com/android/server/am/ProcessList.java
index a421ee65fcfd..5b5ce2cdf978 100644
--- a/services/core/java/com/android/server/am/ProcessList.java
+++ b/services/core/java/com/android/server/am/ProcessList.java
@@ -2613,22 +2613,22 @@ public final class ProcessList implements ProcessStateController.ProcessLruUpdat
             if (!regularZygote) {
                 // webview and app zygote don't have the permission to create the nodes
                 synchronized (app) {
-                    if (!app.mSkipProcessGroupCreation) {
-                        // If we're not told to skip the process group creation, go create it.
-                        final int res = Process.createProcessGroup(uid, startResult.pid);
-                        if (res < 0) {
-                            if (res == -OsConstants.ESRCH) {
-                                Slog.e(ActivityManagerService.TAG,
-                                        "Unable to create process group for "
-                                        + app.processName + " (" + startResult.pid + ")");
-                            } else {
-                                throw new AssertionError("Unable to create process group for "
-                                    + app.processName + " (" + startResult.pid + ")");
-                            }
-                        } else {
-                            app.mProcessGroupCreated = true;
-                        }
-                    }
+                    // if (!app.mSkipProcessGroupCreation) {
+                    //     // If we're not told to skip the process group creation, go create it.
+                    //     final int res = Process.createProcessGroup(uid, startResult.pid);
+                    //     if (res < 0) {
+                    //         if (res == -OsConstants.ESRCH) {
+                    //             Slog.e(ActivityManagerService.TAG,
+                    //                     "Unable to create process group for "
+                    //                     + app.processName + " (" + startResult.pid + ")");
+                    //         } else {
+                    //             throw new AssertionError("Unable to create process group for "
+                    //                 + app.processName + " (" + startResult.pid + ")");
+                    //         }
+                    //     } else {
+                    //         app.mProcessGroupCreated = true;
+                    //     }
+                    // }
                 }
             }
 
-- 
2.51.0

