From 23ecea16fb90e2cf976dc8602e462c3282b63e3b Mon Sep 17 00:00:00 2001
From: Alberto Ponces <ponces26@gmail.com>
Date: Tue, 30 Jan 2024 16:17:43 +0000
Subject: [PATCH 04/15] BpfNetMaps: check if map is null to prevent crash on
 BPF-less devices

Change-Id: I46a949a80e7de0c2d75743445289a778a881a27e
---
 service/src/com/android/server/BpfNetMaps.java | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/service/src/com/android/server/BpfNetMaps.java b/service/src/com/android/server/BpfNetMaps.java
index a7fddd08f0..517da91d87 100644
--- a/service/src/com/android/server/BpfNetMaps.java
+++ b/service/src/com/android/server/BpfNetMaps.java
@@ -940,7 +940,9 @@ public class BpfNetMaps {
         // deletion. netd and skDestroyListener could delete CookieTagMap entry concurrently.
         // So using Set to count the number of entry in the map.
         Set<K> keySet = new ArraySet<>();
-        map.forEach((k, v) -> keySet.add(k));
+        if (map != null) {
+            map.forEach((k, v) -> keySet.add(k));
+        }
         return keySet.size();
     }
 
-- 
2.37.2

